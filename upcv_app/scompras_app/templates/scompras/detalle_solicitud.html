{% extends 'scompras/base.html' %}
{% block content %}
{% load static %}

<!-- Input oculto para solicitud ID -->
<input type="hidden" id="solicitud-id" value="{{ solicitud.id }}">

<!-- Page Title / Breadcrumb -->
<div class="page-body">
  <div class="container-fluid">
    <div class="page-title">
      <div class="row">
        <div class="col-6">
          <h4>Solicitud</h4>
        </div>
        <div class="col-6">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="{% url 'scompras:lista_departamentos' %}">
                <svg class="stroke-icon">
                  <use href="{% static 'assets/svg/icon-sprite.svg#stroke-home' %}"></use>
                </svg>
              </a>
            </li>
            <li class="breadcrumb-item">Sección</li>
            <li class="breadcrumb-item active">Detalle Solicitud</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Container-fluid starts -->
  <div class="container-fluid">
    <table style="width:1160px;margin:0 auto;">
      <tbody>

        <!-- Encabezado con logo e info general -->
        <tr>
          <td>
            <table style="width: 100%; background-image: url({% static 'assets/images/email-template/invoice-3/bg-0.png' %}); background-position: center; background-size: cover; background-repeat: no-repeat; border-radius: 10px;">
              <tbody>
                <tr>
                  <td style="padding: 30px 0px 30px 30px;">
                    <img src="{% static 'assets/images/logo/logo.png' %}" alt="logo">
                  </td>
                  <td style="text-align: end; padding: 30px 30px 30px 0;">
                    <span style="display: block; line-height: 1.5; font-size: 18px; color: #fff; font-weight: 700;">Solicitud de Compras</span>
                    <span style="display: block; line-height: 1.5; font-size: 18px; color: #fff; font-weight: 500;">#{{ solicitud.id }}</span>
                    <span style="display: block; line-height: 1.5; font-size: 18px; color: #fff; font-weight: 500;">{{ solicitud.fecha_solicitud|date:"M d, Y" }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </td>
        </tr>

        <!-- Información del solicitante y sección -->
        <tr>
          <td>
            <table style="width: 100%;">
              <tbody>
                <tr style="padding: 28px 0; display: flex; justify-content: space-between;">
                  <td>
                    <h4 style="font-weight: 600; margin: 12px 0 5px 0; font-size: 18px;">{{ solicitud.usuario.get_full_name }}</h4>
                    <span style="line-height: 1.5; font-size: 14px; font-weight: 400; opacity: 0.8;">Cargo: {{ solicitud.usuario.perfil.cargo }}</span><br>
                    <span style="line-height: 1.5; font-size: 14px; font-weight: 400; opacity: 0.8;">Producto: {{ solicitud.producto.nombre }}</span><br>
                    <span style="line-height: 1.5; font-size: 14px; font-weight: 400; opacity: 0.8;">Sub Producto: {{ solicitud.subproducto.nombre }}</span>
                  </td>
                  <td>
                    <h4 style="font-weight: 600; margin: 12px 0 5px 0; font-size: 18px;">{{ solicitud.seccion.nombre }}</h4>
                    <span style="line-height: 1.5; font-size: 14px; font-weight: 400; opacity: 0.8;">Departamento: {{ solicitud.seccion.departamento.nombre }}</span><br>
                    <span style="line-height: 1.5; font-size: 14px; font-weight: 400; opacity: 0.8;">Estado: {{ solicitud.estado }}</span><br>
                    <span style="line-height: 1.5; font-size: 14px; font-weight: 400; opacity: 0.8;">Prioridad: {{ solicitud.prioridad }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
            
            <h4 style="font-weight: 600; margin: 12px 0 5px 0; font-size: 18px;">Justificación:</h4>
            <p style="opacity: 0.8; font-size: 16px;">
              {{ solicitud.descripcion }}
            </p>
          </td>
        </tr>

        <!-- Línea divisoria -->
        <tr>
          <td>
            <span style="display: block; background: rgba(82, 82, 108, 0.3); height: 1px; width: 100%; margin-bottom:20px;"></span>
          </td>
        </tr>

        <!-- Descripción de productos -->
        <tr>
          <td>
            <table id="tabla-insumos-agregados" style="width: 100%; border-spacing: 0;">
              <thead>
                <tr style="background: #0068ab; color: white;">
                  <th style="padding: 18px 15px; text-align: left;">Código Insumo</th>
                  <th style="padding: 18px 15px; text-align: left;">Nombre</th>
                  <th style="padding: 18px 15px; text-align: left;">Características</th>
                  <th style="padding: 18px 15px; text-align: left;">Presentación</th>
                  <th style="padding: 18px 15px; text-align: left;">Cantidad Unidad Presentación</th>
                  <th style="padding: 18px 15px; text-align: left;">Código Presentación</th>
                  <th style="padding: 18px 15px; text-align: center;">Acción</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="7" style="text-align: center; padding: 18px 15px; color: #666;">
                    No hay insumos agregados aún.
                  </td>
                </tr>
              </tbody>
            </table>
          </td>
        </tr>

        <!-- Botón de volver -->
        <tr>
          <td>
            <div style="margin: 28px 0; display: flex; justify-content: end;">
              <a href="{% url 'scompras:detalle_seccion' departamento_id=solicitud.seccion.departamento.id seccion_id=solicitud.seccion.id %}"
                 style="display: inline-block; background: #0068ab; color: #fff; border-radius: 10px; padding: 12px 24px; font-size: 16px; font-weight: 600; text-decoration: none;">
                Volver a sección
              </a>
            </div>
          </td>
        </tr>

      </tbody>
    </table>
  </div>

  <!-- Card con tabla de Insumos -->
  <div style="width: 1160px; margin: 40px auto; background: #fff; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); padding: 20px;">
    <h3 style="font-weight: 700; margin-bottom: 20px; color: #0068ab;">Lista de Insumos</h3>
    <table id="tabla-insumos" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background-color: #0068ab; color: white; text-align: left;">
          <th style="padding: 12px;">Código Insumo</th>
          <th style="padding: 12px;">Nombre</th>
          <th style="padding: 12px;">Características</th>
          <th style="padding: 12px;">Presentación</th>
          <th style="padding: 12px;">Cantidad Unidad Presentación</th>
          <th style="padding: 12px;">Código Presentación</th>
          <th style="padding: 12px;">Fecha Actualización</th>
          <th style="padding: 12px; text-align:center;">Agregar</th>
        </tr>
      </thead>
      <tbody>
        {% for insumo in insumos %}
        <tr style="border-bottom: 1px solid #ddd;">
          <td style="padding: 12px;">{{ insumo.codigo_insumo }}</td>
          <td style="padding: 12px;">{{ insumo.nombre }}</td>
          <td style="padding: 12px;">{{ insumo.caracteristicas|default:"-" }}</td>
          <td style="padding: 12px;">{{ insumo.nombre_presentacion }}</td>
          <td style="padding: 12px;">{{ insumo.cantidad_unidad_presentacion }}</td>
          <td style="padding: 12px;">{{ insumo.codigo_presentacion }}</td>
          <td style="padding: 12px;">{{ insumo.fecha_actualizacion|date:"M d, Y H:i" }}</td>
          <td style="padding: 12px; text-align:center;">
            <button type="button" class="btn-agregar"
              data-codigo="{{ insumo.codigo_insumo }}"
              data-nombre="{{ insumo.nombre }}"
              data-caracteristicas="{{ insumo.caracteristicas|default:'-' }}"
              data-presentacion="{{ insumo.nombre_presentacion }}"
              data-cantidad="{{ insumo.cantidad_unidad_presentacion }}"
              data-codigo-presentacion="{{ insumo.codigo_presentacion }}">
              Agregar
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" style="text-align: center; padding: 20px;">No hay insumos disponibles.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Botón guardar -->
<div style="margin-top: 20px; text-align: right;">
  <button id="btn-guardar-insumos" 
          style="background: #28a745; color: white; padding: 10px 20px; font-size: 16px; border:none; border-radius: 6px; cursor: pointer;">
    Guardar insumos
  </button>
</div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const botonesAgregar = document.querySelectorAll('.btn-agregar');
  const tbodyInsumosAgregados = document.querySelector('#tabla-insumos-agregados tbody');
  const solicitudId = document.getElementById('solicitud-id').value;

  function yaExiste(codigo) {
    return [...tbodyInsumosAgregados.querySelectorAll('tr')].some(tr => tr.cells[0]?.textContent === codigo);
  }

  function agregarFila(insumo) {
    // Si estaba el mensaje de "No hay insumos", eliminarlo
    const mensajeNoHay = tbodyInsumosAgregados.querySelector('tr td[colspan="7"]');
    if (mensajeNoHay) {
      mensajeNoHay.parentElement.remove();
    }

    if(yaExiste(insumo.codigo_insumo)) {
      alert('Este insumo ya fue agregado.');
      return;
    }

    const fila = document.createElement('tr');
    fila.innerHTML = `
      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">${insumo.codigo_insumo}</td>
      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">${insumo.nombre}</td>
      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">${insumo.caracteristicas}</td>
      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">${insumo.nombre_presentacion}</td>
      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">${insumo.cantidad_unidad_presentacion}</td>
      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">${insumo.codigo_presentacion}</td>
      <td style="padding: 18px 15px; text-align: center; border-bottom: 1px solid #ccc;">
        <button type="button" class="btn-eliminar" style="background: #d9534f; color: white; border:none; border-radius:5px; padding: 5px 10px; cursor:pointer;">
          Eliminar
        </button>
      </td>
    `;
    tbodyInsumosAgregados.appendChild(fila);

    // Evento eliminar (puedes agregar llamada para eliminar en BD si deseas)
    fila.querySelector('.btn-eliminar').addEventListener('click', () => {
      fila.remove();
      if (tbodyInsumosAgregados.children.length === 0) {
        tbodyInsumosAgregados.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 18px 15px; color: #666;">No hay insumos agregados aún.</td></tr>`;
      }
    });
  }

  botonesAgregar.forEach(boton => {
    boton.addEventListener('click', () => {
      const insumoData = {
        codigo_insumo: boton.getAttribute('data-codigo'),
        nombre: boton.getAttribute('data-nombre'),
        caracteristicas: boton.getAttribute('data-caracteristicas'),
        nombre_presentacion: boton.getAttribute('data-presentacion'),
        cantidad_unidad_presentacion: boton.getAttribute('data-cantidad'),
        codigo_presentacion: boton.getAttribute('data-codigo-presentacion')
      };

      fetch("{% url 'scompras:agregar_insumo_solicitud' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
          'solicitud_id': solicitudId,
          'insumo_codigo': insumoData.codigo_insumo,
        })
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          agregarFila(insumoData);
        } else {
          alert(data.error || 'Error al agregar insumo.');
        }
      })
      .catch(() => alert('Error en la comunicación con el servidor.'));
    });
  });
});
</script>

{% endblock %}
