{% extends 'scompras/base.html' %}
{% block content %}
{% load static %}

<!-- Input oculto para solicitud ID -->
<input type="hidden" id="solicitud-id" value="{{ solicitud.id }}">

<!-- Page Title / Breadcrumb -->
<div class="page-body">
  <div class="container-fluid">
    <div class="page-title">
      <div class="row">
        <div class="col-6">
          <h4>Solicitud</h4>
        </div>
        <div class="col-6">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="{% url 'scompras:lista_departamentos' %}">
                <svg class="stroke-icon">
                  <use href="{% static 'assets/svg/icon-sprite.svg#stroke-home' %}"></use>
                </svg>
              </a>
            </li>
            <li class="breadcrumb-item">Sección</li>
            <li class="breadcrumb-item active">Detalle Solicitud</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Container-fluid starts -->
  <div class="container-fluid">
    <table style="width:1160px;margin:0 auto;">
      <tbody>

        <!-- Encabezado con logo e info general -->
        <tr>
          <td>
            <table style="width: 100%; background-image: url({% static 'assets/images/email-template/invoice-3/bg-0.png' %}); background-position: center; background-size: cover; background-repeat: no-repeat; border-radius: 10px;">
              <tbody>
                <tr>
                  <td style="padding: 30px 0px 30px 30px;">
                    <img src="{% static 'assets/images/logo/logo.png' %}" alt="logo">
                  </td>
                  <td style="text-align: end; padding: 30px 30px 30px 0;">
                    <span style="display: block; line-height: 1.5; font-size: 18px; color: #fff; font-weight: 700;">Solicitud de Compras</span>
                    <span style="display: block; line-height: 1.5; font-size: 18px; color: #fff; font-weight: 500;">#{{ solicitud.id }}</span>
                    <span style="display: block; line-height: 1.5; font-size: 18px; color: #fff; font-weight: 500;">{{ solicitud.fecha_solicitud|date:"M d, Y" }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </td>
        </tr>

        <!-- Información del solicitante y sección -->
        <tr>
          <td>
            <table style="width: 100%;">
              <tbody>
                <tr style="padding: 28px 0; display: flex; justify-content: space-between;">
                  <td>
                    <h4 style="font-weight: 600; margin: 12px 0 5px 0; font-size: 18px;">{{ solicitud.usuario.get_full_name }}</h4>
                    <span style="line-height: 1.5; font-size: 14px; font-weight: 400; opacity: 0.8;">Cargo: {{ solicitud.usuario.perfil.cargo }}</span><br>
                    <span style="line-height: 1.5; font-size: 14px; font-weight: 400; opacity: 0.8;">Producto: {{ solicitud.producto.nombre }}</span><br>
                    <span style="line-height: 1.5; font-size: 14px; font-weight: 400; opacity: 0.8;">Sub Producto: {{ solicitud.subproducto.nombre }}</span>
                  </td>
                  <td>
                    <h4 style="font-weight: 600; margin: 12px 0 5px 0; font-size: 18px;">{{ solicitud.seccion.nombre }}</h4>
                    <span style="line-height: 1.5; font-size: 14px; font-weight: 400; opacity: 0.8;">Departamento: {{ solicitud.seccion.departamento.nombre }}</span><br>
                    <span style="line-height: 1.5; font-size: 14px; font-weight: 400; opacity: 0.8;">Estado: {{ solicitud.estado }}</span><br>
                    <span style="line-height: 1.5; font-size: 14px; font-weight: 400; opacity: 0.8;">Prioridad: {{ solicitud.prioridad }}</span>
                  </td>
                </tr>
              </tbody>
            </table>
            
            <h4 style="font-weight: 600; margin: 12px 0 5px 0; font-size: 18px;">Justificación:</h4>
            <p style="opacity: 0.8; font-size: 16px;">
              {{ solicitud.descripcion }}
            </p>
          </td>
        </tr>

        <!-- Línea divisoria -->
        <tr>
          <td>
            <span style="display: block; background: rgba(82, 82, 108, 0.3); height: 1px; width: 100%; margin-bottom:20px;"></span>
          </td>
        </tr>

        <!-- Descripción de productos -->
        <tr>
          <td>
            <!-- Tabla de Insumos -->
            <table id="tabla-insumos-agregados" style="width: 100%; border-spacing: 0;">
              <thead>
                <tr style="background: #0068ab; color: white;">
                  <th style="padding: 18px 15px; text-align: left;">Código Insumo</th>
                  <th style="padding: 18px 15px; text-align: left;">Nombre</th>
                  <th style="padding: 18px 15px; text-align: left;">Características</th>
                  <th style="padding: 18px 15px; text-align: left;">Presentación</th>
                  <th style="padding: 18px 15px; text-align: left;">Cantidad Unidad Presentación</th>
                  <th style="padding: 18px 15px; text-align: left;">Código Presentación</th>
                  <th style="padding: 18px 15px; text-align: center;">Acción</th>
                </tr>
              </thead>
              <tbody>
                {% if detalles %}
                  {% for detalle in detalles %}
                    <tr data-id="{{ detalle.id }}">
                      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">{{ detalle.insumo.codigo_insumo }}</td>
                      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">{{ detalle.insumo.nombre }}</td>
                      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">{{ detalle.insumo.caracteristicas|default:"-" }}</td>
                      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">{{ detalle.insumo.nombre_presentacion }}</td>
                      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">{{ detalle.insumo.cantidad_unidad_presentacion }}</td>
                      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">{{ detalle.insumo.codigo_presentacion }}</td>
                      <td style="padding: 18px 15px; text-align: center; border-bottom: 1px solid #ccc;">
                        <button type="button" class="btn-eliminar" data-id="{{ detalle.id }}"
                          style="background: #0068ab; color: white; border:none; border-radius:5px; padding: 5px 10px; cursor:pointer;">
                          Eliminar
                        </button>
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="7" style="text-align: center; padding: 18px 15px; color: #666;">
                      No hay insumos agregados aún.
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Card con tabla de Insumos -->
  <div style="width: 1160px; margin: 40px auto; background: #fff; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); padding: 20px;">
    <h3 style="font-weight: 700; margin-bottom: 20px; color: #0068ab;">Lista de Insumos</h3>
    <table id="tabla-insumos" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background-color: #0068ab; color: white; text-align: left;">
          <th style="padding: 12px;">Código Insumo</th>
          <th style="padding: 12px;">Nombre</th>
          <th style="padding: 12px;">Características</th>
          <th style="padding: 12px;">Presentación</th>
          <th style="padding: 12px;">Cantidad Unidad Presentación</th>
          <th style="padding: 12px;">Código Presentación</th>
          <th style="padding: 12px; text-align:center;">Agregar</th>
        </tr>
      </thead>
      <tbody>
        {% for insumo in insumos %}
        <tr style="border-bottom: 1px solid #ddd;">
          <td style="padding: 12px;">{{ insumo.codigo_insumo }}</td>
          <td style="padding: 12px;">{{ insumo.nombre }}</td>
          <td style="padding: 12px;">{{ insumo.caracteristicas|default:"-" }}</td>
          <td style="padding: 12px;">{{ insumo.nombre_presentacion }}</td>
          <td style="padding: 12px;">{{ insumo.cantidad_unidad_presentacion }}</td>
          <td style="padding: 12px;">{{ insumo.codigo_presentacion }}</td>
          <td style="padding: 12px; text-align:center;">
            <button type="button" class="btn-agregar"
              data-codigo="{{ insumo.codigo_insumo }}"
              data-nombre="{{ insumo.nombre }}"
              data-caracteristicas="{{ insumo.caracteristicas|default:'-' }}"
              data-presentacion="{{ insumo.nombre_presentacion }}"
              data-cantidad="{{ insumo.cantidad_unidad_presentacion }}"
              data-codigo-presentacion="{{ insumo.codigo_presentacion }}">
              Agregar
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" style="text-align: center; padding: 20px;">No hay insumos disponibles.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const solicitudId = document.getElementById('solicitud-id').value;
  const tbodyInsumosAgregados = document.querySelector('#tabla-insumos-agregados tbody');

  // Función para verificar si un insumo ya está agregado
  function yaExiste(codigo) {
    return [...tbodyInsumosAgregados.querySelectorAll('tr')].some(tr => tr.cells[0]?.textContent === codigo);
  }

  // Función para agregar una fila nueva
  function agregarFila(insumo, id=null) {
    // Elimina mensaje "No hay insumos" si existe
    const mensajeNoHay = tbodyInsumosAgregados.querySelector('tr td[colspan="7"]');
    if (mensajeNoHay) {
      mensajeNoHay.parentElement.remove();
    }

function yaExiste(codigo_insumo, codigo_presentacion) {
  return [...tbodyInsumosAgregados.querySelectorAll('tr')].some(tr => {
    const codigo = tr.cells[0]?.textContent.trim();
    const codigoPres = tr.cells[5]?.textContent.trim();
    return codigo === codigo_insumo && codigoPres === codigo_presentacion;
  });
}


    const fila = document.createElement('tr');
    if(id) fila.setAttribute('data-id', id);
    fila.innerHTML = `
      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">${insumo.codigo_insumo}</td>
      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">${insumo.nombre}</td>
      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">${insumo.caracteristicas}</td>
      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">${insumo.nombre_presentacion}</td>
      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">${insumo.cantidad_unidad_presentacion}</td>
      <td style="padding: 18px 15px; border-bottom: 1px solid #ccc;">${insumo.codigo_presentacion}</td>
      <td style="padding: 18px 15px; text-align: center; border-bottom: 1px solid #ccc;">
        <button type="button" class="btn-eliminar" style="background: #0068ab; color: white; border:none; border-radius:5px; padding: 5px 10px; cursor:pointer;">
          Eliminar
        </button>
      </td>
    `;
    tbodyInsumosAgregados.appendChild(fila);

    // Agregar listener para eliminar fila
    fila.querySelector('.btn-eliminar').addEventListener('click', () => {
      if(id) {
        // Si el insumo ya está guardado, eliminar del backend
        fetch(`/scompras/eliminar-insumo/${id}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
          },
        })
        .then(res => res.json())
        .then(data => {
          if(data.success) {
            fila.remove();
            if (tbodyInsumosAgregados.children.length === 0) {
              tbodyInsumosAgregados.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 18px 15px; color: #666;">No hay insumos agregados aún.</td></tr>`;
            }
          } else {
            alert(data.error || 'No se pudo eliminar el insumo.');
          }
        })
        .catch(() => alert('Error de red al eliminar insumo.'));
      } else {
        // Si es fila recién agregada en frontend y aún no guardada
        fila.remove();
        if (tbodyInsumosAgregados.children.length === 0) {
          tbodyInsumosAgregados.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 18px 15px; color: #666;">No hay insumos agregados aún.</td></tr>`;
        }
      }
    });
  }

  // Agregar event listeners a botones agregar insumo
  document.querySelectorAll('.btn-agregar').forEach(boton => {
    boton.addEventListener('click', () => {
      const insumoData = {
        codigo_insumo: boton.getAttribute('data-codigo'),
        nombre: boton.getAttribute('data-nombre'),
        caracteristicas: boton.getAttribute('data-caracteristicas'),
        nombre_presentacion: boton.getAttribute('data-presentacion'),
        cantidad_unidad_presentacion: boton.getAttribute('data-cantidad'),
        codigo_presentacion: boton.getAttribute('data-codigo-presentacion')
      };

      fetch("{% url 'scompras:agregar_insumo_solicitud' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: new URLSearchParams({
          'solicitud_id': solicitudId,
          'codigo_presentacion': insumoData.codigo_presentacion.trim(),
        })
      })
      .then(response => response.json())
      .then(data => {
        if(data.success) {
          // 'data.insumo_id' esperado en respuesta para el id del detalle guardado
          agregarFila(insumoData, data.insumo_id);
        } else {
          alert(data.error || 'Error al agregar insumo.');
        }
      })
      .catch(() => alert('Error en la comunicación con el servidor.'));
    });
  });

  // Agregar listeners a botones eliminar ya presentes al cargar la página
  document.querySelectorAll('.btn-eliminar').forEach(btn => {
    btn.addEventListener('click', function () {
      const fila = this.closest('tr');
      const insumoId = this.dataset.id;

      fetch(`/scompras/eliminar-insumo/${insumoId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          fila.remove();
          // Mostrar mensaje si ya no hay filas
          if (tbodyInsumosAgregados.children.length === 0) {
            tbodyInsumosAgregados.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 18px 15px; color: #666;">No hay insumos agregados aún.</td></tr>`;
          }
        } else {
          alert(data.error || 'No se pudo eliminar el insumo.');
        }
      })
      .catch(() => {
        alert('Error de red al eliminar insumo.');
      });
    });
  });

});
</script>

{% endblock %}
